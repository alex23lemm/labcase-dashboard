# LabCase projects per project type analysis

```{r warning=FALSE, message=FALSE}

# Load libraries
library(dplyr)
library(xtable)
library(magrittr)
library(ggplot2)
library(lubridate)
library(RColorBrewer)


```

Data as of  **`r as.character(now())`**


## Overview

This report shows the number of created LabCase projects grouped by project type. For this analysis project type is either `internal` or `external`. 

We visualize the grouped projects within several different time spans using bar plots.


## Data extraction and pre-processing




```{r}

projects <- dget(file="../rawData/projectsRaw.R")
custom.fields <- dget(file="../rawData/customFields.R")

projects <- filter(custom.fields, cf_id == 12) %>%
  select(id, cf_value) %>%
  droplevels %>%
  rename(template = cf_value) %>%
  left_join(projects, ., by = 'id')

# Extract project id and customer information from custom.fields data frame
#  id:       project id
#  cf_value: customer name
# In the LC database this is the relevant id - custom fields mapping:
#   13: Customer
projects <- filter(custom.fields, cf_id == 13) %>%
  select(id, cf_value) %>%
  droplevels %>%
  rename(customer = cf_value) %>%
  left_join(projects, ., by = 'id')

# Extract project id and country information from custom.fields data frame
#  id:       project id
#  cf_value: country name
# In the LC database this is the relevant id - custom fields mapping:
#   14: Country
projects <- filter(custom.fields, cf_id == 14) %>%
  select(id, cf_value) %>%
  droplevels %>%
  rename(country = cf_value) %>%
  left_join(projects, ., by = "id")
  

# Extract project id and business line information from custom.fields data frame
#  id:       project id
#  cf_value: business line
# In the LC database this is the relevant id - custom fields mapping:
#   15: Business line
projects <- filter(custom.fields, cf_id == 15) %>%
  select(id, cf_value) %>%
  droplevels %>%
  rename(business_line = cf_value) %>%
  left_join(projects, ., by = "id")



```

First, we need to identify customer names which indicate internal projects.

```{r, results='asis'}

proj_per_cust <- projects %>% count(customer) %>% arrange(customer)

print(xtable(proj_per_cust, 
             caption = "<b>Table 1:</b> Number of projects per customer"), type = 'html', include.rownames = FALSE)

```

Based on the analysis of the table above we construct a regular expression which is used to flag internal projects accordingly. 


```{r}

reg_ex <- '^all$|^ALL$|^All$|All Clients|Annesh|Annika|^Any$|ARIS Internal|ARIS User Group DACH|
Corporate Marketing|CustomerTemplate|Customer Name|^GCS|^gcs|^IBO|^IDS|^[iI]n-[Hh]ouse|
^[iI]nternal|itCampus|^Mathias|[Pp]lanio|^P[p]resales|^Product Marketing|RnD|
rnd|^SAG|^Self$|^Software AG|software ag|^SoftwareAG|^Solution Book|^test|^Test|various'

projects %<>% mutate(
  type = ifelse(grepl(reg_ex, customer), 'internal', 'external')
  )


```

This classification gives us the following intermediate result for all `r dim(projects)[1]` LabCase projects:

```{r}

table(projects$type)

with(projects, table(business_line, type))

```


## Results

In this section we will summarize the pre-processed data to create the desired bar plots.


```{r message=FALSE}

proj_by_year <- projects %>% mutate(
  year = year(created_on)
  ) %>% group_by(year, type) %>%
  summarize(
    n = n()
    ) %>% group_by(year, type) %>%
  mutate(
    cum_n = cumsum(n)
    )

ggplot(proj_by_year, aes(year, n, fill = type)) +
  geom_bar(stat = 'identity', position = position_dodge()) +
  geom_text(aes(label = n), position = position_dodge(.9), size = 2.5, 
            vjust = -0.3) +
  ggtitle('Number of created projects per year') +
  xlab('Year of creation') +
  ylab('Number of projects') +
   scale_fill_brewer(palette = 'Set1') +
  theme(plot.title = element_text(size = rel(1.1)),
        axis.title = element_text(size = 11),
        axis.text = element_text(size = 10)) +
  labs(fill = "Project type") +
   ylim(0, max(proj_by_year$cum_n) * 1.05) 

proj_by_year_qrt <- projects %>% mutate(
  year = year(created_on),
  quarter = quarters(created_on)
  ) %>% group_by(year, quarter, type) %>% 
  summarize(
    n = n()
    ) %>% group_by(year, quarter, type) %>%
   mutate(
      cum_n = cumsum(n)
      )
  
ggplot(proj_by_year_qrt, aes(quarter, n, fill = type)) + 
  geom_bar(stat = 'identity', position = position_dodge()) +
  geom_text(aes(label = n), position = position_dodge(.9), size = 2.5, vjust = -0.3) +
  facet_wrap(~ year ) +
  ggtitle('Number of created projects per year\n(quarterly focus)') +
  xlab('Number of projects') +
  ylab('Quarter of creation') +
  scale_fill_brewer(palette = 'Set1') +
  theme(plot.title = element_text(size = rel(1.1)),
        axis.title = element_text(size = 11),
        axis.text = element_text(size = 10)) +
  labs(fill = "Project type") +
   ylim(0, max(proj_by_year_qrt$cum_n) * 1.05) 


```











